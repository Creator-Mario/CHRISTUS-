<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#f0c050">
<title>CHRISTUS ‚Äì Startseite</title>
<link rel="manifest" href="manifest.json">
<script src="translations.js"></script>
<style>

*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1a1208;--surface:#241a0a;--surface2:#2e2010;--border:#5a3e10;
  --gold:#f5c842;--gold2:#e0a020;--gold3:#fad878;--text:#fdf3dc;--muted:#c8a86a;
  --green:#4ade80;--blue:#60a8f5;--red:#f08080;
  --radius:14px;--radius-sm:9px;
}
body{font-family:'Segoe UI',system-ui,Arial,sans-serif;background:radial-gradient(ellipse at 50% -15%,rgba(240,180,40,.18) 0%,transparent 55%) var(--bg);color:var(--text);min-height:100vh;line-height:1.75}
a{color:var(--gold);text-decoration:none}
button{font-family:inherit;cursor:pointer}

.app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.header-left{display:flex;align-items:center;gap:10px}
.header-logo{font-size:22px;color:var(--gold);font-weight:800;letter-spacing:2px}
.header-version{font-size:.7rem;background:rgba(240,192,80,.15);color:var(--gold);padding:2px 7px;border-radius:10px}
.avatar-btn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;font-size:14px;font-weight:700;color:#0f1028;cursor:pointer;display:flex;align-items:center;justify-content:center}
.main{padding:20px;max-width:700px;margin:0 auto;padding-bottom:80px}
.greeting{margin-bottom:24px}
.greeting-line{font-size:1.5rem;font-weight:700;margin-bottom:4px}
.greeting-sub{font-size:.88rem;color:var(--muted)}
.progress-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:24px}
.progress-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.progress-label span{font-size:.85rem;color:var(--muted)}
.progress-label strong{font-size:.95rem;color:var(--gold)}
.progress-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));border-radius:4px;transition:.4s}
.progress-stats{display:flex;gap:16px;margin-top:12px}
.prog-stat{text-align:center;flex:1}
.prog-stat .n{font-size:1.3rem;font-weight:700;color:var(--gold)}
.prog-stat .l{font-size:.72rem;color:var(--muted)}
.section-title{font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:12px}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:28px}
.action-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px 16px;text-decoration:none;color:var(--text);transition:.2s;display:flex;flex-direction:column;align-items:flex-start;gap:8px;position:relative;overflow:hidden}
.action-card::after{content:'‚Ä∫';position:absolute;right:14px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:1.4rem}
.action-card:hover{border-color:var(--gold);background:var(--surface2);transform:translateY(-1px)}
.action-card.primary{grid-column:1/-1;background:linear-gradient(135deg,#3a2200,#4a2e00);border-color:var(--border)}
.action-card.primary:hover{border-color:var(--gold)}
.action-icon{font-size:28px}
.action-label{font-weight:700;font-size:.95rem}
.action-desc{font-size:.78rem;color:var(--muted)}
.recent-section{margin-bottom:24px}
.recent-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.recent-item:last-child{border-bottom:none}
.recent-nr{background:rgba(240,192,80,.12);color:var(--gold);padding:3px 9px;border-radius:6px;font-size:.78rem;font-weight:700;min-width:40px;text-align:center}
.recent-title{font-size:.88rem;font-weight:600}
.recent-cat{font-size:.75rem;color:var(--muted)}
.recent-btn{margin-left:auto;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:6px;font-size:.78rem;cursor:pointer;transition:.2s;white-space:nowrap}
.recent-btn:hover{border-color:var(--gold);color:var(--gold)}
.empty-recent{color:var(--muted);font-size:.88rem;padding:12px 0}
/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;z-index:100}
.bottom-nav a{flex:1;padding:10px 4px;text-align:center;font-size:.68rem;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:3px;text-decoration:none;transition:.2s}
.bottom-nav a .nav-icon{font-size:20px}
.bottom-nav a.active,.bottom-nav a:hover{color:var(--gold)}
/* INSTALL BANNER */
.install-banner{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.install-banner .install-icon{font-size:28px;flex-shrink:0}
.install-banner .install-info{flex:1}
.install-banner .install-info .install-title{font-weight:700;font-size:.9rem}
.install-banner .install-info .install-sub{font-size:.75rem;color:var(--muted);margin-top:2px}
.install-banner .inst-btn{background:var(--gold);color:#0f1028;border:none;border-radius:7px;padding:8px 16px;font-size:.82rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:.2s;flex-shrink:0}
.install-banner .inst-btn:hover{background:var(--gold2)}
.install-banner .inst-dismiss{background:transparent;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:2px 6px;line-height:1}
.update-banner{position:fixed;top:0;left:0;right:0;z-index:200;background:#1c1d48;border-bottom:2px solid var(--gold);padding:10px 16px;display:flex;align-items:center;gap:10px;transform:translateY(-100%);transition:transform .35s ease;font-size:.85rem}
.update-banner.visible{transform:translateY(0)}
.update-banner .upd-text{flex:1;color:var(--text)}
.update-banner .upd-text strong{color:var(--gold)}
.update-btn{background:var(--gold);color:#0f1028;border:none;border-radius:7px;padding:6px 14px;font-size:.82rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:.2s}
.update-btn:hover{background:var(--gold2)}
.update-dismiss{background:transparent;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer;padding:2px 6px;line-height:1}
</style>
</head>
<body>
<!-- Update available banner (hidden until SW detects new version) -->
<div class="update-banner" id="update-banner">
  <span class="upd-text" id="update-text" data-i18n="update_text">&#128260; <strong>Update verf√ºgbar!</strong> Neue Version der App bereit.</span>
  <button class="update-btn" id="update-btn" data-i18n="update_btn" onclick="applyUpdate()">Jetzt aktualisieren</button>
  <button class="update-dismiss" onclick="dismissUpdate()" data-i18n-title="close">&#10005;</button>
</div>

<!-- Install / Download banner (shown when PWA can be installed) -->
<div class="install-banner" id="install-banner" style="display:none">
  <span class="install-icon">üì≤</span>
  <div class="install-info">
    <div class="install-title" data-i18n="install_label">App installieren</div>
    <div class="install-sub" data-i18n="install_sub">App auf Ger√§t installieren (offline verf√ºgbar)</div>
  </div>
  <button class="inst-btn" id="install-btn" onclick="doInstall()" data-i18n="install_btn">Installieren</button>
  <button class="inst-dismiss" onclick="dismissInstall()" data-i18n-title="close">&#10005;</button>
</div>

<header class="app-header">
  <div class="header-left">
    <span style="font-size:22px">‚úù</span>
    <span class="header-logo">CHRISTUS</span>
    <span class="header-version">v1.17.15</span>
  </div>
  <button class="avatar-btn" id="avatar-btn" onclick="window.location.href='settings.html'" title="Profil & Einstellungen"></button>
</header>

<main class="main">
  <div class="greeting">
    <div class="greeting-line" id="greeting-line">Guten Tag!</div>
    <div class="greeting-sub" id="greeting-sub" data-i18n="greeting_sub">Willkommen in deiner Glaubensbildungs-App</div>
  </div>

  <div class="progress-section">
    <div class="progress-label">
      <span data-i18n="progress_label">Lernfortschritt</span>
      <strong id="prog-pct">0%</strong>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="prog-fill" style="width:0%"></div></div>
    <div class="progress-stats">
      <div class="prog-stat"><div class="n" id="prog-done">0</div><div class="l" data-i18n="stat_done">Abgeschlossen</div></div>
      <div class="prog-stat"><div class="n">42</div><div class="l" data-i18n="stat_total">Module gesamt</div></div>
      <div class="prog-stat"><div class="n" id="prog-remain">42</div><div class="l" data-i18n="stat_remain">Ausstehend</div></div>
    </div>
  </div>

  <p class="section-title" data-i18n="quick_access">Schnellzugriff</p>
  <div class="action-grid">
    <a href="learn.html" class="action-card primary">
      <span class="action-icon">üìö</span>
      <span class="action-label" data-i18n="learn_label">Lernbereich</span>
      <span class="action-desc" data-i18n="learn_desc">7 Kategorien ¬∑ 42 Module ¬∑ Vollst√§ndige Glaubensbildung</span>
    </a>
    <a href="bible.html" class="action-card">
      <span class="action-icon">üìñ</span>
      <span class="action-label" data-i18n="bible_label">Elberfelder Bibel</span>
      <span class="action-desc" data-i18n="bible_desc">Elberfelder 1905 ¬∑ Vollst√§ndige Bibel</span>
    </a>
    <a href="themen.html" class="action-card">
      <span class="action-icon">üóÇÔ∏è</span>
      <span class="action-label" data-i18n="themen_label">Themen</span>
      <span class="action-desc" data-i18n="themen_desc">270 Themen ¬∑ 18 Kategorien</span>
    </a>
    <a href="learn.html#glossary" class="action-card" onclick="localStorage.setItem('learn_screen','glossary')">
      <span class="action-icon">üìò</span>
      <span class="action-label" data-i18n="glossary_label">Themen Aufgaben</span>
      <span class="action-desc" data-i18n="glossary_desc">Schl√ºsselbegriffe</span>
    </a>
    <a href="settings.html" class="action-card">
      <span class="action-icon">‚öôÔ∏è</span>
      <span class="action-label" data-i18n="settings_label">Einstellungen</span>
      <span class="action-desc" data-i18n="settings_desc">Profil & Sprache</span>
    </a>
  </div>

  <p class="section-title" data-i18n="recently">Zuletzt bearbeitet</p>
  <div id="recent-list"></div>
</main>

<nav class="bottom-nav">
  <a href="home.html" class="active">
    <span class="nav-icon">üè†</span><span data-i18n="nav_home">Start</span>
  </a>
  <a href="learn.html">
    <span class="nav-icon">üìö</span><span data-i18n="nav_learn">Lernen</span>
  </a>
  <a href="bible.html">
    <span class="nav-icon">üìñ</span><span data-i18n="nav_bible">Bibel</span>
  </a>
  <a href="themen.html">
    <span class="nav-icon">üóÇÔ∏è</span><span data-i18n="nav_themen">Themen</span>
  </a>
  <a href="learn.html" onclick="localStorage.setItem('learn_screen','glossary')">
    <span class="nav-icon">üìò</span><span data-i18n="nav_glossary">Themen Aufgaben</span>
  </a>
  <a href="settings.html">
    <span class="nav-icon">‚öôÔ∏è</span><span data-i18n="nav_profile">Profil</span>
  </a>
</nav>

<script>
function greet(name) {
  const h = new Date().getHours();
  const time = h < 12 ? t('greeting_morning') : h < 18 ? t('greeting_day') : t('greeting_evening');
  document.getElementById('greeting-line').textContent = time + (name && name !== 'Gast' ? ', ' + name + '!' : '!');
  if (name && name !== 'Gast') {
    document.getElementById('greeting-sub').textContent = t('greeting_back');
    document.getElementById('avatar-btn').textContent = name.substring(0,2).toUpperCase();
  } else {
    document.getElementById('avatar-btn').textContent = 'üë§';
  }
}

function loadProgress() {
  const done = new Set(JSON.parse(localStorage.getItem('christus_done') || '[]'));
  const n = done.size; const total = 42; const pct = Math.round(n / total * 100);
  document.getElementById('prog-done').textContent = n;
  document.getElementById('prog-remain').textContent = total - n;
  document.getElementById('prog-pct').textContent = pct + '%';
  document.getElementById('prog-fill').style.width = pct + '%';
}

function loadRecent() {
  const recent = JSON.parse(localStorage.getItem('christus_recent') || '[]');
  const el = document.getElementById('recent-list');
  if (recent.length === 0) {
    el.innerHTML = '<div class="empty-recent">' + t('empty_recent') + '</div>';
    return;
  }
  el.innerHTML = recent.slice(0,4).map(m =>
    '<div class="recent-item">' +
    '<div class="recent-nr">' + m.nr + '</div>' +
    '<div><div class="recent-title">' + m.title + '</div>' +
    '<div class="recent-cat">' + m.cat + '</div></div>' +
    '<button class="recent-btn" onclick=\'openModule(' + JSON.stringify(m.nr) + ')\'>' + t('continue_btn') + '</button>' +
    '</div>'
  ).join('');
}

function openModule(nr) {
  localStorage.setItem('learn_open_module', nr);
  window.location.href = 'learn.html';
}

// Init
const session = JSON.parse(localStorage.getItem('christus_session') || 'null');
if (!session) { window.location.href = 'login.html'; }
else if (!session.email) { window.location.href = 'bible.html'; }
else {
  applyLang();
  greet(session.name);
  loadProgress();
  loadRecent();
}

// ‚îÄ‚îÄ PWA Install prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  if (!localStorage.getItem('install_dismissed')) {
    document.getElementById('install-banner').style.display = 'flex';
  }
});

function doInstall() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(() => {
    deferredInstallPrompt = null;
    document.getElementById('install-banner').style.display = 'none';
  });
}

function dismissInstall() {
  document.getElementById('install-banner').style.display = 'none';
  localStorage.setItem('install_dismissed', '1');
}

window.addEventListener('appinstalled', () => {
  document.getElementById('install-banner').style.display = 'none';
  deferredInstallPrompt = null;
});

// ‚îÄ‚îÄ Service Worker update detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pendingWorker = null;
let isUpdating = false;

function showUpdateBanner() {
  document.getElementById('update-banner').classList.add('visible');
}
function dismissUpdate() {
  document.getElementById('update-banner').classList.remove('visible');
}
function applyUpdate() {
  if (pendingWorker) {
    // Tell the waiting SW to take over, then reload
    isUpdating = true;
    pendingWorker.postMessage('SKIP_WAITING');
  } else {
    window.location.reload();
  }
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('../sw.js').then(reg => {
    // A new SW is already waiting when the page opens
    if (reg.waiting) {
      pendingWorker = reg.waiting;
      showUpdateBanner();
    }
    // A new SW installs while the page is open
    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      if (!newWorker) return;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          pendingWorker = newWorker;
          showUpdateBanner();
        }
      });
    });
  }).catch(err => console.warn('SW registration failed:', err));

  // Only reload after the user has explicitly clicked "Jetzt aktualisieren"
  // (isUpdating=true). Without this guard, clients.claim() in the SW activate
  // handler would fire controllerchange on first visit and reload the page
  // before the update banner can ever be shown.
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (isUpdating) window.location.reload();
  });
}
</script>
</body>
</html>
