<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#f4d03f">
<title>CHRISTUS ‚Äì Einstellungen</title>
<link rel="manifest" href="manifest.json">
<style>

*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1923;--surface:#1a2636;--surface2:#223044;--border:#2d4060;
  --gold:#f4d03f;--gold2:#e8c129;--text:#e8eef4;--muted:#7a8fa8;
  --green:#2ecc71;--blue:#3498db;--red:#e74c3c;
  --radius:14px;--radius-sm:9px;
}
body{font-family:'Segoe UI',system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
a{color:var(--gold);text-decoration:none}
button{font-family:inherit;cursor:pointer}

.app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100}
.back-btn{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 14px;color:var(--text);font-size:.85rem;cursor:pointer;transition:.2s}
.back-btn:hover{border-color:var(--gold);color:var(--gold)}
.header-title{font-weight:700;font-size:1rem}
.main{padding:20px;max-width:600px;margin:0 auto;padding-bottom:40px}
.profile-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:20px;display:flex;align-items:center;gap:16px}
.big-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#1a1a2e;flex-shrink:0}
.profile-info .name{font-size:1.2rem;font-weight:700}
.profile-info .sub{font-size:.82rem;color:var(--muted);margin-top:3px}
.section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.section-header{padding:14px 18px;border-bottom:1px solid var(--border);font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted)}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-size:.9rem;font-weight:600}
.setting-sub{font-size:.78rem;color:var(--muted);margin-top:2px}
.setting-value{font-size:.85rem;color:var(--muted)}
.setting-action{background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 14px;color:var(--text);font-size:.82rem;cursor:pointer;transition:.2s}
.setting-action:hover{border-color:var(--gold);color:var(--gold)}
.setting-action.danger{color:var(--red);border-color:rgba(231,76,60,.3)}
.setting-action.danger:hover{border-color:var(--red);background:rgba(231,76,60,.1)}
.lang-grid{display:flex;gap:8px;flex-wrap:wrap;padding:14px 18px}
.lang-btn{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 14px;color:var(--text);font-size:.85rem;cursor:pointer;transition:.2s}
.lang-btn.active{border-color:var(--gold);background:rgba(244,208,63,.12);color:var(--gold);font-weight:700}
.version-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;text-align:center;color:var(--muted);font-size:.82rem}
.version-card .v{font-size:1.4rem;font-weight:700;color:var(--gold);display:block;margin-bottom:4px}
.msg{font-size:.82rem;text-align:center;margin-top:8px;min-height:18px;color:var(--green)}
/* PIN DIALOG */
.pin-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.pin-overlay.open{display:flex}
.pin-dialog{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px;max-width:340px;width:100%}
.pin-dialog h3{font-size:1rem;margin-bottom:16px;color:var(--gold)}
.pin-dialog input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;color:var(--text);font-size:1rem;outline:none;margin-bottom:10px;font-family:inherit;letter-spacing:4px;text-align:center}
.pin-dialog input:focus{border-color:var(--gold)}
.pin-dialog-btns{display:flex;gap:8px;margin-top:4px}
.pin-dialog-btns button{flex:1;padding:10px;border-radius:var(--radius-sm);font-size:.88rem;font-weight:600;cursor:pointer;transition:.2s;font-family:inherit}
.btn-cancel{background:var(--surface2);border:1px solid var(--border);color:var(--muted)}
.btn-cancel:hover{border-color:var(--border);color:var(--text)}
.btn-save{background:var(--gold);border:none;color:#1a1a2e}
.btn-save:hover{background:var(--gold2)}
.pin-err{font-size:.78rem;color:var(--red);min-height:16px;margin-bottom:4px}
</style>
</head>
<body>
<header class="app-header">
  <button class="back-btn" onclick="window.location.href='home.html'">‚Üê Zur√ºck</button>
  <span class="header-title">Einstellungen</span>
</header>

<main class="main">
  <div class="profile-card">
    <div class="big-avatar" id="big-avatar">?</div>
    <div class="profile-info">
      <div class="name" id="profile-name">L√§dt‚Ä¶</div>
      <div class="sub" id="profile-sub"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">Konto</div>
    <div class="setting-row">
      <div><div class="setting-label">Benutzername</div><div class="setting-sub" id="username-display"></div></div>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">PIN √§ndern</div><div class="setting-sub">Neuen 4-stelligen PIN setzen</div></div>
      <button class="setting-action" onclick="changePin()">√Ñndern</button>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Lernfortschritt</div><div class="setting-sub" id="prog-info"></div></div>
      <button class="setting-action danger" onclick="resetProgress()">Zur√ºcksetzen</button>
    </div>
  </div>

  <div class="section">
    <div class="section-header">Sprache</div>
    <div class="lang-grid">
      <button class="lang-btn" data-lang="de" onclick="setLang('de')">üá©üá™ Deutsch</button>
      <button class="lang-btn" data-lang="en" onclick="setLang('en')">üá¨üáß English</button>
      <button class="lang-btn" data-lang="es" onclick="setLang('es')">üá™üá∏ Espa√±ol</button>
      <button class="lang-btn" data-lang="pt" onclick="setLang('pt')">üáßüá∑ Portugu√™s</button>
    </div>
  </div>

  <div class="section">
    <div class="section-header">App</div>
    <div class="setting-row">
      <div><div class="setting-label">Offline-Modus</div><div class="setting-sub" id="sw-status">Pr√ºfe‚Ä¶</div></div>
      <span class="setting-value" id="sw-badge"></span>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Cache leeren</div><div class="setting-sub">App-Daten neu laden</div></div>
      <button class="setting-action" onclick="clearCache()">Leeren</button>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Abmelden</div><div class="setting-sub">Session beenden</div></div>
      <button class="setting-action danger" onclick="logout()">Abmelden</button>
    </div>
  </div>

  <div class="version-card">
    <span class="v">v1.10</span>
    CHRISTUS ‚Äì Glaubensbildung &amp; Nachfolge<br>
    Freikirchliche Theologische Grundbildung<br><br>
    <span style="font-size:.75rem">7 Kategorien ¬∑ 42 Module ¬∑ Offline-f√§hig</span>
  </div>
  <div class="msg" id="msg"></div>
</main>

<!-- PIN change dialog -->
<div class="pin-overlay" id="pin-overlay">
  <div class="pin-dialog">
    <h3>üîí PIN √§ndern</h3>
    <input type="password" id="pin-new" placeholder="Neuer PIN" maxlength="4" inputmode="numeric" autocomplete="new-password">
    <input type="password" id="pin-new2" placeholder="PIN best√§tigen" maxlength="4" inputmode="numeric" autocomplete="new-password">
    <div class="pin-err" id="pin-err"></div>
    <div class="pin-dialog-btns">
      <button class="btn-cancel" onclick="closePinDialog()">Abbrechen</button>
      <button class="btn-save" onclick="savePinDialog()">Speichern</button>
    </div>
  </div>
</div>

<script>
function showMsg(t, err) {
  const m = document.getElementById('msg');
  m.style.color = err ? 'var(--red)' : 'var(--green)';
  m.textContent = t;
  setTimeout(() => m.textContent = '', 3000);
}

function loadProfile() {
  const session = JSON.parse(localStorage.getItem('christus_session') || 'null');
  if (!session) { window.location.href = 'login.html'; return; }
  const name = session.name;
  document.getElementById('big-avatar').textContent = name !== 'Gast' ? name.substring(0,2).toUpperCase() : 'üë§';
  document.getElementById('profile-name').textContent = name;
  document.getElementById('username-display').textContent = name;

  const users = JSON.parse(localStorage.getItem('christus_users') || '{}');
  if (users[name] && users[name].created) {
    const d = new Date(users[name].created).toLocaleDateString('de');
    document.getElementById('profile-sub').textContent = 'Mitglied seit ' + d;
  } else {
    document.getElementById('profile-sub').textContent = 'Gast-Modus';
  }

  const done = JSON.parse(localStorage.getItem('christus_done') || '[]').length;
  document.getElementById('prog-info').textContent = done + ' von 42 Modulen abgeschlossen';

  const lang = localStorage.getItem('selectedLanguage') || 'de';
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
}

function setLang(lang) {
  localStorage.setItem('selectedLanguage', lang);
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
  showMsg('Sprache gespeichert.');
}

function changePin() {
  const session = JSON.parse(localStorage.getItem('christus_session') || 'null');
  if (!session || session.name === 'Gast') { showMsg('Im Gast-Modus nicht m√∂glich.', true); return; }
  document.getElementById('pin-new').value = '';
  document.getElementById('pin-new2').value = '';
  document.getElementById('pin-err').textContent = '';
  document.getElementById('pin-overlay').classList.add('open');
  setTimeout(() => document.getElementById('pin-new').focus(), 50);
}
function closePinDialog() {
  document.getElementById('pin-overlay').classList.remove('open');
}
function savePinDialog() {
  const p1 = document.getElementById('pin-new').value.trim();
  const p2 = document.getElementById('pin-new2').value.trim();
  const errEl = document.getElementById('pin-err');
  if (!/^\d{4}$/.test(p1)) { errEl.textContent = 'PIN muss genau 4 Ziffern sein.'; return; }
  if (p1 !== p2) { errEl.textContent = 'PINs stimmen nicht √ºberein.'; return; }
  const session = JSON.parse(localStorage.getItem('christus_session') || 'null');
  const users = JSON.parse(localStorage.getItem('christus_users') || '{}');
  if (!users[session.name]) { errEl.textContent = 'Benutzer nicht gefunden.'; return; }
  users[session.name].pin = p1;
  localStorage.setItem('christus_users', JSON.stringify(users));
  closePinDialog();
  showMsg('PIN erfolgreich ge√§ndert!');
}

function resetProgress() {
  if (!confirm('Lernfortschritt wirklich zur√ºcksetzen?')) return;
  localStorage.removeItem('christus_done');
  localStorage.removeItem('christus_recent');
  showMsg('Fortschritt zur√ºckgesetzt.');
  loadProfile();
}

function clearCache() {
  if ('caches' in window) {
    caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k)))).then(() => {
      showMsg('Cache geleert. App wird neu geladen‚Ä¶');
      setTimeout(() => window.location.reload(true), 1500);
    });
  } else { showMsg('Kein Cache vorhanden.'); }
}

function logout() {
  localStorage.removeItem('christus_session');
  window.location.href = 'login.html';
}

// SW status
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistration('/app/sw.js').then(reg => {
    document.getElementById('sw-status').textContent = reg ? 'Aktiv ‚Äì App ist offline verf√ºgbar' : 'Nicht registriert';
    document.getElementById('sw-badge').textContent = reg ? '‚úÖ' : '‚ùå';
  });
} else {
  document.getElementById('sw-status').textContent = 'Nicht unterst√ºtzt';
  document.getElementById('sw-badge').textContent = '‚ùå';
}

loadProfile();
</script>
</body>
</html>
