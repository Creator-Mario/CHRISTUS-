name: Build & Release Android APK

on:
  push:
    branches: [main, copilot/add-sqlite-bible-database]  # PR branch included so APK is built before merge
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'elberfelder_1905.csv'
      - 'tools/**'
      - 'schema/**'
      - 'data/**'
      - '.github/workflows/build-apk.yml'
  workflow_dispatch:   # Allow manual trigger from any branch

permissions:
  contents: write   # Needed to create GitHub Releases

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.0'
          channel: stable
          cache: true

      - name: Set up Java (Android SDK requirement)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Generate passages JSON
        run: python3 tools/generate_passages_json.py

      - name: Build Bible SQLite database
        run: python3 tools/build_bible_db.py

      - name: Bootstrap Flutter project (Android platform files)
        run: |
          # flutter create adds missing platform dirs without touching lib/
          flutter create \
            --project-name christus \
            --org com.christusbibel \
            --platforms android \
            .

      - name: Install Dart dependencies
        run: flutter pub get

      - name: Build APK (release)
        run: flutter build apk --release

      - name: Rename APK
        run: |
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-release.apk \
             dist/christus-bibel.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: christus-bibel-apk
          path: dist/christus-bibel.apk
          retention-days: 90

      - name: Create / update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: apk-latest
          name: "Christus Bibel â€“ Android APK"
          body: |
            ## ğŸ“± Christus Bibel â€“ Android App

            ### Download & Installation

            1. **[â¬‡ï¸ christus-bibel.apk]** herunterladen (SchaltflÃ¤che unten)
            2. Auf dem Android-GerÃ¤t Ã¶ffnen
            3. Falls gefragt: â€Aus unbekannten Quellen installieren" erlauben
               *(Einstellungen â†’ Sicherheit â†’ Unbekannte Quellen)*
            4. App installieren und starten âœ…

            ### Inhalt
            - ğŸ“– Elberfelder 1905 (Public Domain) â€“ 66 BÃ¼cher, 31.102 Verse
            - ğŸ¯ 228 kuratierte Bibelstellen in 18 Themen
            - ğŸ” Volltext-Suche
            - ğŸ“µ Komplett offline â€“ kein Internet nÃ¶tig

            ### Alternative: Browser-App (Android + iPhone + Desktop)
            Ohne Installation, direkt im Browser Ã¶ffnen oder als PWA installieren:
            ğŸ‘‰ https://creator-mario.github.io/CHRISTUS-/preview/standalone.html
          files: dist/christus-bibel.apk
          make_latest: true
          draft: false
          prerelease: false
