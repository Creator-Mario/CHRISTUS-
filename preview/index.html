<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Christus – Bibel Vorschau</title>
  <style>
    :root {
      --primary: #1a237e;
      --primary-light: #534bae;
      --accent: #e8eaf6;
      --text: #212121;
      --text-secondary: #616161;
      --bg: #fafafa;
      --card-bg: #ffffff;
      --border: #e0e0e0;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 800px;
      margin: 0 auto;
    }

    /* ── App Bar ── */
    #app-bar {
      background: var(--primary);
      color: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,.3);
    }
    #back-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      padding: 4px 8px;
      display: none;
    }
    #app-title { flex: 1; font-size: 18px; font-weight: 600; }
    #search-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      padding: 4px 8px;
    }

    /* ── Search bar (shown in search view) ── */
    #search-bar {
      background: var(--primary);
      padding: 8px 12px;
      display: none;
    }
    #search-input {
      width: 100%;
      padding: 8px 12px;
      font-size: 15px;
      border: none;
      border-radius: 4px;
      outline: none;
    }

    /* ── Views ── */
    .view { display: none; padding: 8px 0; }
    .view.active { display: block; }

    /* ── Book list ── */
    .list-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--card-bg);
      cursor: pointer;
      transition: background .15s;
    }
    .list-item:hover { background: var(--accent); }
    .avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 600;
      flex-shrink: 0;
      margin-right: 14px;
    }

    /* ── Chapter grid ── */
    #chapter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 8px;
      padding: 12px;
    }
    .chapter-btn {
      padding: 12px 4px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      transition: background .15s;
    }
    .chapter-btn:hover { background: var(--primary-light); }

    /* ── Verse list ── */
    .verse-row {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--card-bg);
      line-height: 1.6;
    }
    .verse-num {
      font-weight: 700;
      color: var(--primary);
      margin-right: 6px;
    }

    /* ── Search results ── */
    .result-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--card-bg);
      cursor: pointer;
    }
    .result-item:hover { background: var(--accent); }
    .result-ref {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    mark { background: #fff176; border-radius: 2px; }

    /* ── Loading / empty states ── */
    #loading {
      text-align: center;
      padding: 60px 16px;
      color: var(--text-secondary);
      font-size: 15px;
    }
    .empty { text-align: center; padding: 40px 16px; color: var(--text-secondary); }
  </style>
</head>
<body>

<!-- App Bar -->
<div id="app-bar">
  <button id="back-btn" onclick="goBack()">&#8592;</button>
  <span id="app-title">Christus – Bibel</span>
  <button id="search-btn" onclick="showSearch()">&#128269;</button>
</div>

<!-- Search input (visible only in search view) -->
<div id="search-bar">
  <input id="search-input" type="search" placeholder="Bibelstellen suchen …"
         oninput="onSearchInput(this.value)" />
</div>

<!-- Loading overlay -->
<div id="loading">Datenbank wird geladen …</div>

<!-- View: Books -->
<div id="view-books" class="view">
  <div id="book-list"></div>
</div>

<!-- View: Chapters -->
<div id="view-chapters" class="view">
  <div id="chapter-grid"></div>
</div>

<!-- View: Verses -->
<div id="view-verses" class="view">
  <div id="verse-list"></div>
</div>

<!-- View: Search results -->
<div id="view-search" class="view">
  <div id="search-results"></div>
</div>

<!-- sql.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.12.0/sql-wasm.min.js"
        crossorigin="anonymous"
        integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb"></script>
<script>
// ── State ──────────────────────────────────────────────────────────────────
let db = null;
let history = [];          // navigation stack of view names
let books = [];            // [{id, name_de}]
let searchTimer = null;

// ── Initialise ─────────────────────────────────────────────────────────────
(async function init() {
  try {
    const SQL = await initSqlJs({
      locateFile: file =>
        `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.12.0/${file}`
    });

    // Load the SQLite file (one directory up from /preview/)
    const resp = await fetch('../assets/db/bible.sqlite');
    if (!resp.ok) throw new Error(`HTTP ${resp.status} – ${resp.url}`);
    const buf = await resp.arrayBuffer();
    db = new SQL.Database(new Uint8Array(buf));

    // Pre-load all books once.
    books = query('SELECT id, name_de FROM books ORDER BY id');

    document.getElementById('loading').style.display = 'none';
    showView('view-books');
    renderBooks();
  } catch (err) {
    document.getElementById('loading').innerHTML =
      `<b>Fehler beim Laden:</b><br>${err.message}<br><br>` +
      `<small>Starte einen lokalen HTTP-Server im Repository-Stammverzeichnis:<br>` +
      `<code>python3 -m http.server 8000</code><br>` +
      `dann öffne <a href="http://localhost:8000/preview/">http://localhost:8000/preview/</a></small>`;
  }
})();

// ── DB helpers ─────────────────────────────────────────────────────────────
function query(sql, params = []) {
  const stmt = db.prepare(sql);
  stmt.bind(params);
  const rows = [];
  while (stmt.step()) rows.push(stmt.getAsObject());
  stmt.free();
  return rows;
}

// ── Navigation ─────────────────────────────────────────────────────────────
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const isRoot = (id === 'view-books');
  document.getElementById('back-btn').style.display = isRoot ? 'none' : 'block';
  document.getElementById('search-btn').style.display =
    (id === 'view-search') ? 'none' : 'block';
  document.getElementById('search-bar').style.display =
    (id === 'view-search') ? 'block' : 'none';
}

function navigate(viewId) {
  history.push(document.querySelector('.view.active').id);
  showView(viewId);
}

function goBack() {
  if (history.length === 0) return;
  const prev = history.pop();
  showView(prev);
  if (prev === 'view-search') {
    document.getElementById('search-bar').style.display = 'block';
  }
}

// ── Books ──────────────────────────────────────────────────────────────────
function renderBooks() {
  const list = document.getElementById('book-list');
  list.innerHTML = books.map(b => `
    <div class="list-item" onclick="openBook(${b.id}, '${escHtml(b.name_de)}')">
      <div class="avatar">${b.id}</div>
      <span>${escHtml(b.name_de)}</span>
    </div>`).join('');
  document.getElementById('app-title').textContent = 'Christus – Bibel';
}

function openBook(bookId, bookName) {
  const chapters = query(
    'SELECT DISTINCT chapter FROM bible_verses WHERE book_id=? ORDER BY chapter',
    [bookId]
  );
  const grid = document.getElementById('chapter-grid');
  grid.innerHTML = chapters.map(c =>
    `<button class="chapter-btn" onclick="openChapter(${bookId},'${escHtml(bookName)}',${c.chapter})">${c.chapter}</button>`
  ).join('');
  document.getElementById('app-title').textContent = bookName;
  navigate('view-chapters');
}

// ── Chapters ───────────────────────────────────────────────────────────────
function openChapter(bookId, bookName, chapter) {
  const verses = query(
    'SELECT verse, text FROM bible_verses WHERE book_id=? AND chapter=? ORDER BY verse',
    [bookId, chapter]
  );
  const list = document.getElementById('verse-list');
  list.innerHTML = verses.map(v =>
    `<div class="verse-row"><span class="verse-num">${v.verse}</span>${escHtml(v.text)}</div>`
  ).join('');
  document.getElementById('app-title').textContent = `${bookName} ${chapter}`;
  navigate('view-verses');
}

// ── Search ─────────────────────────────────────────────────────────────────
function showSearch() {
  document.getElementById('app-title').textContent = 'Suchen';
  navigate('view-search');
  document.getElementById('search-input').focus();
  document.getElementById('search-results').innerHTML =
    '<div class="empty">Suchbegriff eingeben …</div>';
}

function onSearchInput(val) {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => runSearch(val), 300);
}

function runSearch(raw) {
  const q = raw.trim();
  const container = document.getElementById('search-results');
  if (!q) {
    container.innerHTML = '<div class="empty">Suchbegriff eingeben …</div>';
    return;
  }

  // Build safe FTS5 query: quote every token.
  const terms = tokenise(q);
  const ftsQuery = terms.map(t => '"' + t.replace(/"/g, '""') + '"').join(' ');

  let rows;
  try {
    rows = query(
      `SELECT f.book_id, f.chapter, f.verse, v.text,
              b.name_de AS book_name
       FROM   bible_verses_fts f
       JOIN   bible_verses v ON v.book_id=f.book_id AND v.chapter=f.chapter AND v.verse=f.verse
       JOIN   books b ON b.id=f.book_id
       WHERE  bible_verses_fts MATCH ?
       LIMIT  60`,
      [ftsQuery]
    );
  } catch (_) {
    container.innerHTML = '<div class="empty">Ungültiger Suchbegriff.</div>';
    return;
  }

  if (!rows.length) {
    container.innerHTML = '<div class="empty">Keine Ergebnisse gefunden.</div>';
    return;
  }

  container.innerHTML = rows.map(r => {
    const highlighted = highlightTerms(r.text, terms);
    return `<div class="result-item"
                 onclick="openChapter(${r.book_id},'${escHtml(r.book_name)}',${r.chapter})">
              ${highlighted}
              <div class="result-ref">${escHtml(r.book_name)} ${r.chapter},${r.verse}</div>
            </div>`;
  }).join('');
}

// ── Helpers ────────────────────────────────────────────────────────────────
function tokenise(s) {
  return s.trim().split(/\s+/).filter(Boolean);
}

function escHtml(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/**
 * Highlight all occurrences of *terms* in plain *text*.
 * Collects all match ranges first, merges overlaps, then builds safe HTML
 * in a single pass – avoiding nested or broken <mark> tags.
 */
function highlightTerms(text, terms) {
  // Collect [start, end) ranges for every term match (case-insensitive).
  const ranges = [];
  terms.forEach(term => {
    const re = new RegExp(escRegex(term), 'gi');
    let m;
    while ((m = re.exec(text)) !== null) {
      ranges.push([m.index, m.index + m[0].length]);
    }
  });

  if (!ranges.length) return escHtml(text);

  // Sort by start, then merge overlapping ranges.
  ranges.sort((a, b) => a[0] - b[0] || a[1] - b[1]);
  const merged = [ranges[0]];
  for (let i = 1; i < ranges.length; i++) {
    const last = merged[merged.length - 1];
    if (ranges[i][0] < last[1]) {
      last[1] = Math.max(last[1], ranges[i][1]);
    } else {
      merged.push(ranges[i]);
    }
  }

  // Build output HTML in one pass over plain text.
  let html = '';
  let pos = 0;
  merged.forEach(([start, end]) => {
    html += escHtml(text.slice(pos, start));
    html += '<mark>' + escHtml(text.slice(start, end)) + '</mark>';
    pos = end;
  });
  html += escHtml(text.slice(pos));
  return html;
}

function escRegex(s) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
</script>
</body>
</html>
